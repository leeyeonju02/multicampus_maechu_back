<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.multipjt.multi_pjt.crew.dao.battle.CrewBattleMapper">

    <!--  @@@@@@@@@ 크루 배틀 @@@@@@@@@  -->

    <!-- 배틀 생성 --> 

    <insert id="createCrewBattleRow"
            parameterType="com.multipjt.multi_pjt.crew.domain.battle.CrewBattleRequestDTO">
        INSERT INTO CrewBattle(battle_id, battle_name, battle_goal, battle_end_recruitment, battle_end_date, battle_content, battle_state, crew_id)
        VALUES(#{battle_id}, #{battle_name}, #{battle_goal}, #{battle_end_recruitment}, #{battle_end_date}, #{battle_content}, #{battle_state}, #{crew_id});
    </insert>

    <!-- 배틀 목록 조회 --> 

    <select id="selectCrewBattleRow"
            parameterType="Integer"
            resultType="com.multipjt.multi_pjt.crew.domain.battle.CrewBattleResponseDTO">
            SELECT *
            FROM CrewBattle
            WHERE crew_id = #{crew_id}
            ORDER BY battle_state;
    </select>
    
    <!-- 배틀 참가 --> 

    <insert id="createBattleMemberRow"
            parameterType="com.multipjt.multi_pjt.crew.domain.battle.BattleMemberRequestDTO">
        INSERT INTO BattleMember(participant_id, battle_id, member_id)
        VALUES(#{participant_id}, #{battle_id}, #{member_id});
    </insert>

    <!--  @@@@@@@@@ 배틀 상세보기 @@@@@@@@@  -->

    <!-- 배틀 참가 멤버 조회 --> 

    <select id="selectBattleMemberRow"
            parameterType="Integer"
            resultType="com.multipjt.multi_pjt.crew.domain.battle.BattleMemberResponseDTO">
        SELECT 
            bm.participant_id, 
            bm.battle_id, 
            bm.member_id, 
            m.nickname, 
            up.profile_region, 
            up.profile_age, 
            SUM(cbf.feed_kcal) AS total_feed_kcal, 
            SUM(cbf.feed_exTime) AS total_feed_exTime,
            COUNT(cbf.feed_id) AS feed_count,
            COUNT(v.participant_id) AS vote_count,
            cb.badge_level
        FROM BattleMember bm
        LEFT JOIN UserProfile up ON bm.member_id = up.member_id
        LEFT JOIN Member m ON bm.member_id = m.member_id
        LEFT JOIN CrewBattleFeed cbf ON bm.participant_id = cbf.participant_id
        LEFT JOIN CrewBadge cb ON bm.member_id = cb.member_id
        LEFT JOIN Vote v ON bm.participant_id = v.participant_id
        WHERE bm.battle_id = #{battle_id}
        GROUP BY bm.participant_id, bm.battle_id, bm.member_id
        ORDER BY vote_count DESC;
    </select>

    <!-- 피드 작성 --> 

    <insert id="createCrewBattleFeedRow"
            parameterType="com.multipjt.multi_pjt.crew.domain.battle.CrewBattleFeedRequestDTO">
            INSERT INTO CrewBattleFeed(feed_id, feed_img, feed_post, feed_kcal, feed_sport, feed_exTime, participant_id, battle_id)
            VALUES(#{feed_id}, #{feed_img}, #{feed_post}, #{feed_kcal}, #{feed_sport}, #{feed_exTime}, #{participant_id}, #{battle_id});
    </insert>

    <!-- 피드 조회 --> 

    <select id="selectCrewBattleFeedRow"
            parameterType="Integer"
            resultType="com.multipjt.multi_pjt.crew.domain.battle.CrewBattleFeedResponseDTO">
        SELECT *
        FROM CrewBattleFeed
        WHERE participant_id = #{participant_id};
    </select>

    <!-- 투표 --> 

    <insert id="createVoteRow"
            parameterType="com.multipjt.multi_pjt.crew.domain.battle.CrewVoteRequestDTO">
        INSERT INTO Vote(vote_id, battle_id, participant_id, member_id)
        VALUES(#{vote_id}, #{battle_id}, #{participant_id}, #{member_id});
    </insert>
</mapper>
